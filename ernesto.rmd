## Part 3
```{r}
library(tidyverse)
filter(d, has_cf == 1)
sub_df <- filter(d, has_cf == 1)
nonsub_df <- filter(d, has_cf == 0)
```

```{r}
nonsub_df %>%
  select(COVIDseverity, comorb_bronchiectasis_J47) %>%
  table()

```

```{r}
sub_df %>%
  select(COVIDseverity, comorb_bronchiectasis_J47) %>%
  table()
  
```

```{r}
hr <- filter(d, heartrate <= 220)
ppp <- ggplot(hr, aes(x = COVIDseverity, y = heartrate, fill = has_cf)) +
  geom_boxplot() + 
  ggtitle("Covid 19 Severity Based on Patients Heartrate")
  scale_fill_manual(labels = c("Covid 19 Severity", "Heartrate of the Patient"))
ppp <- ppp + guides(fill=guide_legend(title="CF Indicator"))
ppp
```

```{r}
p <- ggplot(sub_df, aes(x = COVIDseverity, fill = race)) +
  geom_bar() + 
  labs(x = "Covid 19 Severity",
       y = "Number of Patients",
       title = "Covid 19 Severity Within each Race of Patients with CF")
p <- p + guides(fill=guide_legend(title="Race"))
p
```

```{r}
pp <- ggplot(nonsub_df, aes(x = COVIDseverity, fill = race)) +
  geom_bar() + 
  labs(x = "Covid 19 Severity",
       y = "Number of Patients",
       title = "Covid 19 Severity Within each Race of Patients without CF")
pp <- pp + guides(fill=guide_legend(title="Race"))
pp
```

```{r}
# example of contigency table
table(d$COVIDseverity, d$INOTROPES)
```

```{r}
# patients with cf
sub_df %>%
  group_by(COVIDseverity, comorb_bronchiectasis_J47) %>%
  summarize(N = n()) %>%
  mutate(Ratio = round(100*(N / sum(N)), 1), "%") %>%
  knitr::kable()

# patients without cf
nonsub_df %>%
  group_by(COVIDseverity, comorb_bronchiectasis_J47) %>%
  summarize(N = n()) %>%
  mutate(Ratio = round(100*(N / sum(N)), 1), "%") %>%
  knitr::kable()
```

```{r}
# patients with cf
sub_df %>%
  group_by(COVIDseverity, comorb_copd_J40_J44) %>%
  summarize(N = n()) %>%
  mutate(Ratio = round(100*(N / sum(N)), 1), "%") %>%
  knitr::kable()

# patients without cf
nonsub_df %>%
  group_by(COVIDseverity, comorb_copd_J40_J44) %>%
  summarize(N = n()) %>%
  mutate(Ratio = round(100*(N / sum(N)), 1), "%") %>%
  knitr::kable()
```

```{r}
# should look at asthma
# patients with cf
sub_df %>%
  group_by(COVIDseverity, comorb_asthma_J45) %>%
  summarize(N = n()) %>%
  mutate(Ratio = round(100*(N / sum(N)), 1), "%") %>%
  knitr::kable()

# patients without cf
nonsub_df %>%
  group_by(COVIDseverity, comorb_asthma_J45) %>%
  summarize(N = n()) %>%
  mutate(Ratio = round(100*(N / sum(N)), 1), "%") %>%
  knitr::kable()
```

```{r}
# patients with cf
sub_df %>%
  group_by(COVIDseverity, comorb_nasal_polyps_J33) %>%
  summarize(N = n()) %>%
  mutate(Ratio = round(100*(N / sum(N)), 1), "%") %>%
  knitr::kable()

# patients without cf
nonsub_df %>%
  group_by(COVIDseverity, comorb_nasal_polyps_J33) %>%
  summarize(N = n()) %>%
  mutate(Ratio = round(100*(N / sum(N)), 1), "%") %>%
  knitr::kable()
```

```{r}
#patients with cf 
sub_df %>%
  group_by(COVIDseverity, comorb_hemoptysisR042) %>%
  summarize(N = n()) %>%
  mutate(Ratio = round(100*(N / sum(N)), 1), "%") %>%
  knitr::kable()

# patients without cf
nonsub_df %>%
  group_by(COVIDseverity, comorb_hemoptysisR042) %>%
  summarize(N = n()) %>%
  mutate(Ratio = round(100*(N / sum(N)), 1), "%") %>%
  knitr::kable()
```

```{r}
#patients with cf 
sub_df %>%
  group_by(COVIDseverity, comorb_pneumothorax_J93) %>%
  summarize(N = n()) %>%
  mutate(Ratio = round(100*(N / sum(N)), 1), "%") %>%
  knitr::kable()

# patients without cf
nonsub_df %>%
  group_by(COVIDseverity, comorb_pneumothorax_J93) %>%
  summarize(N = n()) %>%
  mutate(Ratio = round(100*(N / sum(N)), 1), "%") %>%
  knitr::kable()
```

```{r}
# should look at resp failure
#patients with cf 
sub_df %>%
  group_by(COVIDseverity, comorb_resp_failure_J96) %>%
  summarize(N = n()) %>%
  mutate(Ratio = round(100*(N / sum(N)), 1), "%") %>%
  knitr::kable()

# patients without cf
nonsub_df %>%
  group_by(COVIDseverity, comorb_resp_failure_J96) %>%
  summarize(N = n()) %>%
  mutate(Ratio = round(100*(N / sum(N)), 1), "%") %>%
  knitr::kable()
```

```{r}
#patients with cf 
sub_df %>%
  group_by(COVIDseverity, comorb_pneumothorax_J93) %>%
  summarize(N = n()) %>%
  mutate(Ratio = round(100*(N / sum(N)), 1), "%") %>%
  knitr::kable()

# patients without cf
nonsub_df %>%
  group_by(COVIDseverity, comorb_pneumothorax_J93) %>%
  summarize(N = n()) %>%
  mutate(Ratio = round(100*(N / sum(N)), 1), "%") %>%
  knitr::kable()
```

```{r}
#patients with cf 
sub_df %>%
  group_by(COVIDseverity, comorb_malnutrition) %>%
  summarize(N = n()) %>%
  mutate(Ratio = round(100*(N / sum(N)), 1), "%") %>%
  knitr::kable()

# patients without cf
nonsub_df %>%
  group_by(COVIDseverity, comorb_malnutrition) %>%
  summarize(N = n()) %>%
  mutate(Ratio = round(100*(N / sum(N)), 1), "%") %>%
  knitr::kable()
```

```{r}
#patients with cf 
sub_df %>%
  group_by(COVIDseverity, comorb_other_nutritional_deficiencies_E50_E64) %>%
  summarize(N = n()) %>%
  mutate(Ratio = round(100*(N / sum(N)), 1), "%") %>%
  knitr::kable()

# patients without cf
nonsub_df %>%
  group_by(COVIDseverity, comorb_other_nutritional_deficiencies_E50_E64) %>%
  summarize(N = n()) %>%
  mutate(Ratio = round(100*(N / sum(N)), 1), "%") %>%
  knitr::kable()
```

```{r}
#patients with cf 
sub_df %>%
  group_by(COVIDseverity, comorb_typeI_diabetes_E10) %>%
  summarize(N = n()) %>%
  mutate(Ratio = round(100*(N / sum(N)), 1), "%") %>%
  knitr::kable()

# patients without cf
nonsub_df %>%
  group_by(COVIDseverity, comorb_typeI_diabetes_E10) %>%
  summarize(N = n()) %>%
  mutate(Ratio = round(100*(N / sum(N)), 1), "%") %>%
  knitr::kable()
```

```{r}
#patients with cf 
sub_df %>%
  group_by(COVIDseverity, comorb_typeII_diabetes_E11) %>%
  summarize(N = n()) %>%
  mutate(Ratio = round(100*(N / sum(N)), 1), "%") %>%
  knitr::kable()

# patients without cf
nonsub_df %>%
  group_by(COVIDseverity, comorb_typeII_diabetes_E11) %>%
  summarize(N = n()) %>%
  mutate(Ratio = round(100*(N / sum(N)), 1), "%") %>%
  knitr::kable()
```

```{r}
#patients with cf 
sub_df %>%
  group_by(COVIDseverity, comorb_obesity_overweight_E66) %>%
  summarize(N = n()) %>%
  mutate(Ratio = round(100*(N / sum(N)), 1), "%") %>%
  knitr::kable()

# patients without cf
nonsub_df %>%
  group_by(COVIDseverity, comorb_obesity_overweight_E66) %>%
  summarize(N = n()) %>%
  mutate(Ratio = round(100*(N / sum(N)), 1), "%") %>%
  knitr::kable()
```

```{r}
#patients with cf 
sub_df %>%
  group_by(COVIDseverity, comorb_liver_disease_K70_K77) %>%
  summarize(N = n()) %>%
  mutate(Ratio = round(100*(N / sum(N)), 1), "%") %>%
  knitr::kable()

# patients without cf
nonsub_df %>%
  group_by(COVIDseverity, comorb_liver_disease_K70_K77) %>%
  summarize(N = n()) %>%
  mutate(Ratio = round(100*(N / sum(N)), 1), "%") %>%
  knitr::kable()
```

```{r}
# this crazy to look at
#patients with cf 
sub_df %>%
  group_by(COVIDseverity, comorb_other_GI_notLiver_K_excludesK70K77) %>%
  summarize(N = n()) %>%
  mutate(Ratio = round(100*(N / sum(N)), 1), "%") %>%
  knitr::kable()

# patients without cf
nonsub_df %>%
  group_by(COVIDseverity, comorb_other_GI_notLiver_K_excludesK70K77) %>%
  summarize(N = n()) %>%
  mutate(Ratio = round(100*(N / sum(N)), 1), "%") %>%
  knitr::kable()
```

```{r}
#patients with cf 
sub_df %>%
  group_by(COVIDseverity, comorb_essential_hypertension_I10) %>%
  summarize(N = n()) %>%
  mutate(Ratio = round(100*(N / sum(N)), 1), "%") %>%
  knitr::kable()

# patients without cf
nonsub_df %>%
  group_by(COVIDseverity, comorb_essential_hypertension_I10) %>%
  summarize(N = n()) %>%
  mutate(Ratio = round(100*(N / sum(N)), 1), "%") %>%
  knitr::kable()
```

```{r}
#patients with cf 
sub_df %>%
  group_by(COVIDseverity, comorb_hypertensive_heart_disease_I11) %>%
  summarize(N = n()) %>%
  mutate(Ratio = round(100*(N / sum(N)), 1), "%") %>%
  knitr::kable()

# patients without cf
nonsub_df %>%
  group_by(COVIDseverity, comorb_hypertensive_heart_disease_I11) %>%
  summarize(N = n()) %>%
  mutate(Ratio = round(100*(N / sum(N)), 1), "%") %>%
  knitr::kable()
```

```{r}
#patients with cf 
sub_df %>%
  group_by(COVIDseverity, comorb_chronic_kidney_disease_N18) %>%
  summarize(N = n()) %>%
  mutate(Ratio = round(100*(N / sum(N)), 1), "%") %>%
  knitr::kable()

# patients without cf
nonsub_df %>%
  group_by(COVIDseverity, comorb_chronic_kidney_disease_N18) %>%
  summarize(N = n()) %>%
  mutate(Ratio = round(100*(N / sum(N)), 1), "%") %>%
  knitr::kable()
```

```{r}
#patients with cf 
sub_df %>%
  group_by(COVIDseverity, comorb_nicotine_dependence_F17) %>%
  summarize(N = n()) %>%
  mutate(Ratio = round(100*(N / sum(N)), 1), "%") %>%
  knitr::kable()

# patients without cf
nonsub_df %>%
  group_by(COVIDseverity, comorb_nicotine_dependence_F17) %>%
  summarize(N = n()) %>%
  mutate(Ratio = round(100*(N / sum(N)), 1), "%") %>%
  knitr::kable()
```

```{r}
#patients with cf 
sub_df %>%
  group_by(COVIDseverity, comorb_heart_failure_I50) %>%
  summarize(N = n()) %>%
  mutate(Ratio = round(100*(N / sum(N)), 1), "%") %>%
  knitr::kable()

# patients without cf
nonsub_df %>%
  group_by(COVIDseverity, comorb_heart_failure_I50) %>%
  summarize(N = n()) %>%
  mutate(Ratio = round(100*(N / sum(N)), 1), "%") %>%
  knitr::kable()
```

```{r}
#patients with cf 
sub_df %>%
  group_by(COVIDseverity, comorb_ischemic_heart_disease_I20_I25) %>%
  summarize(N = n()) %>%
  mutate(Ratio = round(100*(N / sum(N)), 1), "%") %>%
  knitr::kable()

# patients without cf
nonsub_df %>%
  group_by(COVIDseverity, comorb_ischemic_heart_disease_I20_I25) %>%
  summarize(N = n()) %>%
  mutate(Ratio = round(100*(N / sum(N)), 1), "%") %>%
  knitr::kable()
```

```{r}
#patients with cf 
sub_df %>%
  group_by(COVIDseverity, comorb_lung_transplant_Z942) %>%
  summarize(N = n()) %>%
  mutate(Ratio = round(100*(N / sum(N)), 1), "%") %>%
  knitr::kable()

# patients without cf
nonsub_df %>%
  group_by(COVIDseverity, comorb_lung_transplant_Z942) %>%
  summarize(N = n()) %>%
  mutate(Ratio = round(100*(N / sum(N)), 1), "%") %>%
  knitr::kable()
```

```{r}

```
## Part 4

```{r}
con_tab <- d %>% 
  select(COVIDseverity, has_cf, age_at_encounter)
```


```{r}
#contingency table, compares non-cf covid severity with race
non_cf %>% 
  group_by(COVIDseverity, encountertype) %>% 
  summarize(N = n()) %>% 
  mutate(Ratio = round(N / sum(N), 3)) %>% 
  knitr::kable()
```

```{r}
#contingency table, compares cf covid severity with encountertype
cf %>% 
  group_by(COVIDseverity, encountertype) %>% 
  summarize(N = n()) %>% 
  mutate(Ratio = round(N / sum(N), 3)) %>% 
  knitr::kable()
```

```{r}
#contingency table, compares cf covid severity with encountertype
non_cf %>% 
  group_by(COVIDseverity, encountertype) %>% 
  summarize(N = n()) %>% 
  mutate(Ratio = round(N / sum(N), 3)) %>% 
  knitr::kable()
```

```{r}
#contingency table, compares covid severity between cf and non-cf
con_tab %>% 
  group_by(has_cf, COVIDseverity) %>% 
  summarize(N = n()) %>% 
  mutate(Ratio = round((N / sum(N)), 3)) %>% 
  knitr::kable()
```

```{r}
#contingency table, compares covid severity between cf and non-cf (shows percentage)
con_tab %>% 
#contingency table, compares covid severity between cf and non-cf
ratetable <- con_tab %>% 
  group_by(has_cf, COVIDseverity) %>% 
  summarize(N = n()) %>% 
  mutate(Ratio = round(100*(N / sum(N)), 1), "%") %>% 
  knitr::kable()
```
```{r}
ratetable <- con_tab %>% 
  group_by(has_cf, COVIDseverity) %>% 
  summarize(N = n()) %>% 
  mutate(Ratio = round((N / sum(N)), 3))
```


```{r}
#bar plot, covid severity for cf patients
ggplot(ratetable, aes(x = has_cf,
                      y = Ratio,
                      fill = COVIDseverity), position = "dodge") +
    labs(x = "Patients Without CF", 
       y = "Rate", 
       title = "COVID Severity Among Children With/Without Cystic Fibrosis") +
  geom_bar(stat = "identity")
```

```{r}
library(ggplot2)
theme_set(theme_classic())

ratetable <-
```


```{r}
#bar plot, covid severity for non-cf patients
ggplot(non_cf) +
  geom_bar(mapping = aes(x=has_cf, fill = COVIDseverity), 
           position = 'dodge') +
  scale_y_continuous(labels = comma) +
  labs(x = "Patients Without CF", 
       y = "Count", 
       title = "COVID Severity Among Children Without Cystic Fibrosis")
```

```{r}
ggplot(con_tab) +
  geom_bar(mapping = aes(x=has_cf, fill = COVIDseverity), 
           position = 'dodge') +
  coord_cartesian(ylim = c(0, 60000)) +
  scale_y_continuous(labels = comma)
```

Logistic Regression
---------------------
```{r}
library(aod)
library(ggplot2)
```

```{r}
covsev01 <- d
```

```{r}
covsev01 <-
  d["COVIDseverity"][d["COVIDseverity"] == 2] <- 1
```

```{r}
covid_data2 <- d %>% 
  select(COVIDseverity, has_cf, age_at_encounter)
```

```{r}
covid_data2["COVIDseverity"][covid_data2["COVIDseverity"] == 2] <- 1
```

```{r}
model <- glm(COVIDseverity ~., family = binomial(link='logit'),
             data = covid_data2)
summary(model)
```

```{r}
confint(model)
```

```{r}
confint.default(model)
```

```{r}
exp(coef(model))
```
```{r}
exp(cbind(OR = coef(model), confint(model)))
```

```{r}
wald.test(b = coef(model), Sigma = vcov(model), Terms = 1:2)
```

```{r}
ggplot(covid_data2, aes(x = has_cf, y = COVIDseverity)) + geom_ribbon(aes(ymin = LL,
    ymax = UL, fill = rank), alpha = 0.2) + geom_line(aes(colour = rank),
    size = 1)
```

## prop comp
```{r prop comp}
# Need to always load the package though
library(epitools)
library(rmeta)
library(pROC)
library(nnet)

#####################################################
#####################################################
# This is the prop.comp() function we will use
#######
prop.comp <- function( x, estimate="all", conf.level=.95, transpose=FALSE ){
	if( transpose ) x <- t(x)
	rslt <- vector( "list", length=3 )
	names( rslt ) <- c( "riskdiff", "riskratio", "oddsratio" )
	diff.rslt <- suppressWarnings(prop.test( x, conf.level=conf.level ))
	rslt[[1]] <- rslt[[2]] <- rslt[[3]] <- epitab( x, method="riskratio", pvalue="chi2", conf.level=conf.level )$tab
	colnames( rslt[[1]] )[5] <- "riskdiff"
	rslt[[1]][,5] <- c(0,diff(rev(diff.rslt$estimate)))
	rslt[[1]][2,6:7] <- diff.rslt$conf.int
	colnames( rslt[[3]] )[5] <- "oddsratio"
	rslt[[3]][,5:8] <- suppressWarnings(epitab( x, method="oddsratio", pvalue="chi2", conf.level=conf.level )$tab[,5:8])
	if(is.null(names(dimnames(x)))){
		for(i in 1:3){
			colnames(rslt[[i]])[c(1,3)] <- c("Outcome=0", "Outcome=1")
			rownames(rslt[[i]]) <- c("Group=1", "Group=2")
			}
	}
	if( is.element( estimate, c("all", "oddsratio") ) ){ 
		if(is.null(names(dimnames(x)))){
			warning( "Estimated probabilities represent Pr[ Outcome | Group ]. For estimates of 
			Pr[ Group | Outcome ], change the value of 'transpose'.")
		}
		else
			warning( paste("Estimated probabilities represent Pr[", names(dimnames(x))[2], 
			"|",names(dimnames(x))[1], "]. For estimates of 
			Pr[", names(dimnames(x))[1], "|",names(dimnames(x))[2], "], change the value of 'transpose'.") )
		}
	if( estimate == "riskdiff" ) return(rslt[[1]])
	else if( estimate == "riskratio" ) return(rslt[[2]])
	else if( estimate == "oddsratio" ) return(rslt[[3]])
	else return(rslt)
}
