---
title: "Research-Project-BrandonH"
author: "Brandon Huett"
date: '2022-07-14'
output: html_document
---

```{r}
con_tab <- d %>% 
  select(COVIDseverity, has_cf, age_at_encounter)
```

```{r}
#contingency table, compares non-cf covid severity with race
non_cf %>% 
  group_by(COVIDseverity, encountertype) %>% 
  summarize(N = n()) %>% 
  mutate(Ratio = round(N / sum(N), 3)) %>% 
  knitr::kable()
```

```{r}
#contingency table, compares cf covid severity with encountertype
d %>% 
  group_by(COVIDseverity, encountertype) %>% 
  summarize(N = n()) %>% 
  mutate(Ratio = round(N / sum(N), 3)) %>% 
  knitr::kable()
```

```{r}
#contingency table, compares cf covid severity with encountertype
non_cf %>% 
  group_by(COVIDseverity, encountertype) %>% 
  summarize(N = n()) %>% 
  mutate(Ratio = round(N / sum(N), 3)) %>% 
  knitr::kable()
```

```{r}
#contingency table, compares covid severity between cf and non-cf
con_tab %>% 
  group_by(has_cf, COVIDseverity) %>% 
  summarize(N = n()) %>% 
  mutate(Ratio = round((N / sum(N)), 3)) %>% 
  knitr::kable()
```

```{r}
ratetable <- con_tab %>% 
  group_by(has_cf, COVIDseverity)
```


```{r}
#contingency table, compares covid severity between cf and non-cf
  ratetable %>% 
  group_by(has_cf, COVIDseverity) %>% 
  summarize(N = n()) %>% 
  mutate(Ratio = round(100*(N / sum(N)), 1), "%") %>% 
  knitr::kable()
```

```{r}
ratetable <- con_tab %>% 
  group_by(has_cf, COVIDseverity) %>% 
  summarize(N = n()) %>% 
  mutate(Ratio = round((N / sum(N)), 3))
```

```{r}
#bar plot, covid severity for cf patients
ggplot(ratetable, aes(x = has_cf,
                      y = Ratio,
                      fill = COVIDseverity), position = "dodge") +
    labs(x = "Patients Without CF", 
       y = "Rate", 
       title = "COVID Severity Among Children With/Without Cystic Fibrosis") +
  geom_bar(stat = "identity")
```

```{r}
#bar plot, covid severity for non-cf patients
ggplot(non_cf) +
  geom_bar(mapping = aes(x=has_cf, fill = COVIDseverity), 
           position = 'dodge') +
  scale_y_continuous(labels = comma) +
  labs(x = "Patients Without CF", 
       y = "Count", 
       title = "COVID Severity Among Children Without Cystic Fibrosis")
```

```{r}
ggplot(con_tab) +
  geom_bar(mapping = aes(x=has_cf, fill = COVIDseverity), 
           position = 'dodge') +
  coord_cartesian(ylim = c(0, 60000)) +
  scale_y_continuous(labels = comma)
```

```{r}
  morb_df_age %>% 
  group_by(has_cf, COVIDseverity) %>% 
  summarize(N = n()) %>% 
  mutate(Ratio = round(100*(N / sum(N)), 1), "%") %>% 
  knitr::kable()
```

```{r}
treat_df <- d %>% 
  select(has_cf, COVIDseverity, INOTROPES, REMDESIVIR, CCP,
         DEXAMETHASONE, ENOXAPARIN, HEPARIN, IVIG,
         METHYLPREDNISOLONE, RITUXIMAB, TOCILIZUMAB,
         ASPIRIN, LOPINAVIR_OR_RITONAVIR)
```

```{r}
  treat_df %>% 
  group_by(has_cf, COVIDseverity, INOTROPES) %>% 
  summarize(N = n()) %>% 
  mutate(Ratio = round(100*(N / sum(N)), 1), "%") %>% 
  knitr::kable()
```


Logistic Regression

```{r}
library(aod)
library(ggplot2)
library(mlbench)
library(pROC)
library(caret)
library(InformationValue)
library(ISLR)
```

```{r}
covsev01 <- d
```

```{r}
covsev01["COVIDseverity"][covsev01["COVIDseverity"] == 2] <- 1
```

```{r}
covid_data2 <- d %>% 
  select(COVIDseverity, has_cf, age_at_encounter)
```

```{r}
covid_data2["COVIDseverity"][covid_data2["COVIDseverity"] == 2] <- 1
```

```{r}
model <- glm(COVIDseverity ~., family = binomial(link='logit'),
             data = morb_df_01)
summary(model)
```

```{r}
predict(model)
```

```{r}
morb_grouped <- morb_df_01
```

```{r}
morb_grouped %>% 
  mutate(
    respiratory_disease = case_when(
      bronchiectasis == 1,
      asthma == 1,
      bronchiectasis ==0,
      asthma == 0
    )
  )
```


```{r}
confint(model)
```

```{r}
confint.default(model)
```

```{r}
wald.test(b = coef(model), Sigma = vcov(model), Terms = 1:2)
```

```{r}
exp(coef(model))
```

```{r}
exp(cbind(OR = coef(model), confint(model)))
```

```{r}
hist(model$fitted.values,main = " Histogram ",xlab = "Probability of 'pos' diabetes", col = 'light green')
```

```{r}
#created altered data frame of morb_df to have severity to two levels
morb_df_01 <- morb_df
morb_df_01['COVIDseverity'][morb_df_01['COVIDseverity'] == 2] <- 1

morb_df_01$COVIDseverity <- factor(morb_df_01$COVIDseverity, c(0,1))
```

```{r}
morb_age <- morb_df_01
```

```{r}
morb_df_01 <- d %>%
  select(has_cf, COVIDseverity, starts_with('comorb'))

colnames(morb_df_01) <- c('has_cf', 'COVIDseverity', 'bronchiectasis',
                        'pulmonary_disease', 'asthma', 'nasal_polyps',
                        'hemoptysis', 'pneumothorax', 'resp_failure', 
                        'malnutrition', 'other_nutri_deficiency', 
                        'type1_diabetes', 'type2_diabetes', 'obesity', 
                        'liver_disease', 'other_GI_notLiver', 
                        'essential_hypertension', 'hypertensive_heart_disease',
                        'chronic_kidney_disease', 'nicotine_dependence', 
                        'heart_failure', 'ischemic_heart_disease', 
                        'lung_transplant')

```

```{r}
ggplot(morb_df_age, aes(x = age_at_encounter, y = hemoptysis)) + 
  geom_point(alpha=.5) +
  stat_smooth(method="glm", se=FALSE, method.args = list(family=binomial))
```



