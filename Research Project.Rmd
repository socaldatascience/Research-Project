---
title: "Child Patients with Covid-19 and Cystic Fibrosis"
author: "Alfonso Vieyra, Brandon Huett, Allison Cher, Brittnie Villasenor"
date: '2022-06-30'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(ggplot2)
library(scales)
```
<<<<<<< HEAD

=======
>>>>>>> b05b752bf06ca6305982e887454b3706d5b359ce

## Part 1

```{r morbidity Tables}
#table with severity, cf and comorbidities NOTE: Changed names for readability
morb_df <- d %>%
  select(has_cf, COVIDseverity, starts_with('comorb'))


colnames(morb_df) <- c('has_cf', 'COVIDseverity', 'bronchiectasis',
                        'pulmonary_disease', 'asthma', 'nasal_polyps',
                        'hemoptysis', 'pneumothorax', 'resp_failure', 
                        'malnutrition', 'other_nutri_deficiency', 
                        'type1_diabetes', 'type2_diabetes', 'obesity', 
                        'liver_disease', 'other_GI_notLiver', 
                        'essential_hypertension', 'hypertensive_heart_disease',
                        'chronic_kidney_disease', 'nicotine_dependence', 
                        'heart_failure', 'ischemic_heart_disease', 
                        'lung_transplant')

#table of non cystic fibrosis patients
morb_noCF <- morb_df  %>%
  filter(has_cf == 0)

#table of cystic fibrosis patients
morb_CF <- morb_df %>%
  filter(has_cf == 1)
```


```{r funcy}
#created a function to calculate the proportions in a 1D vector
prop1 <- function(arr, denom) {
  count = 1
  for (x in arr)
  {
    arr[count] = round(x / denom, 2)
    count = count + 1
  }
  return(arr)
}
```


```{r Severity Levels noCF}

#Tables of severity symptoms level 0
severity0_noCF <- morb_noCF %>%
  filter(COVIDseverity == 0) %>%
  select(-has_cf, -COVIDseverity)

indx0 <- sapply(severity0_noCF, is.factor)
severity0_noCF[indx0] <- lapply(severity0_noCF[indx0], 
                           function(x) as.numeric(as.character(x)))

#Tables of severity symptoms level 1
severity1_noCF <- morb_noCF %>%
  filter(COVIDseverity == 1) %>%
  select(-has_cf, -COVIDseverity)

indx1 <- sapply(severity1_noCF, is.factor)
severity1_noCF[indx1] <- lapply(severity1_noCF[indx1], 
                           function(x) as.numeric(as.character(x)))

#Tables of severity symptoms level 2 
severity2_noCF <- morb_noCF %>%
  filter(COVIDseverity == 2) %>%
  select(-has_cf, -COVIDseverity)

indx2 <- sapply(severity2_noCF, is.factor)
severity2_noCF[indx2] <- lapply(severity2_noCF[indx2], 
                           function(x) as.numeric(as.character(x)))

#Vectorized severities of counts
asymptomatic <- colSums(severity0_noCF)
mild_symptoms <- colSums(severity1_noCF)
severe_symptoms <- colSums(severity2_noCF)

#created new df based on counts of morbidities across severity lvls 
library(reshape2)

sev_lvls_noCF <- rbind(asymptomatic, mild_symptoms, severe_symptoms)
sev_lvls_noCF[1, ] <- prop1(sev_lvls_noCF[1,], 296236)
sev_lvls_noCF[2, ] <- prop1(sev_lvls_noCF[2,], 34015)
sev_lvls_noCF[3, ] <- prop1(sev_lvls_noCF[3,], 20743)

melted_sev_lvls_noCF <- melt(sev_lvls_noCF)
colnames(melted_sev_lvls_noCF) <- c('severity_lvl', 'morbidity','proportion')
```


```{r visual non-CF}
options(scipen = 999)
ggplot(melted_sev_lvls_noCF, aes(x=morbidity, y = proportion, fill = proportion)) +
  geom_bar(stat = 'identity') +
  coord_flip() +
  labs( x = 'Morbidities', y = 'Total Reported Conditions') +
  ggtitle('Dominant Conditions in Non-CF patients with Covid 19') +
  theme(plot.title = element_text(hjust = 0.5)) +
  facet_wrap(~severity_lvl) + 
  theme(axis.text.x = element_text(angle=45))
```



```{r Severity Levels CF}
#Tables of severity symptoms level 0
severity0_CF <- morb_CF %>%
  filter(COVIDseverity == 0) %>%
  select(-has_cf, -COVIDseverity)

indx0_cf <- sapply(severity0_CF, is.factor)
severity0_CF[indx0_cf] <- lapply(severity0_CF[indx0_cf], 
                           function(x) as.numeric(as.character(x)))

#Tables of severity symptoms level 1
severity1_CF <- morb_CF %>%
  filter(COVIDseverity == 1) %>%
  select(-has_cf, -COVIDseverity)

indx1_cf <- sapply(severity1_CF, is.factor)
severity1_CF[indx1_cf] <- lapply(severity1_CF[indx1_cf], 
                           function(x) as.numeric(as.character(x)))

#Tables of severity symptoms level 2 
severity2_CF <- morb_CF %>%
  filter(COVIDseverity == 2) %>%
  select(-has_cf, -COVIDseverity)

indx2_cf <- sapply(severity2_CF, is.factor)
severity2_CF[indx2_cf] <- lapply(severity2_CF[indx2_cf], 
                           function(x) as.numeric(as.character(x)))

#Vectorized severities of counts
asympt_mild <- colSums(severity0_CF)
moderate_symptoms <- colSums(severity1_CF)
severe_symptoms <- colSums(severity2_CF)

#created new df based on counts of morbidities across severity lvls 
sev_lvls_CF <- rbind(asympt_mild, moderate_symptoms, severe_symptoms)
sev_lvls_CF[1,] <- prop1(sev_lvls_CF[1,], 8454)
sev_lvls_CF[2,] <- prop1(sev_lvls_CF[2,], 1216)
sev_lvls_CF[3,] <- prop1(sev_lvls_CF[3,], 646)

melted_sev_lvls_CF <- melt(sev_lvls_CF)
colnames(melted_sev_lvls_CF) <- c('severity_lvl', 'morbidity','proportion')
```

```{r visual CF}
ggplot(melted_sev_lvls_CF, aes(x=morbidity, y = proportion, fill = proportion)) +
  geom_bar(stat = 'identity') +
  coord_flip()+
  labs( x = 'Morbidities', y = 'Proportion of Conditions') +
  ggtitle('Dominant Conditions in CF patients with Covid 19') +
  theme(plot.title = element_text(hjust = 0.5)) +
  facet_wrap(~severity_lvl) + 
  theme(axis.text.x = element_text(angle=45))
```

```{r cf non cf}
has_CF <- morb_CF %>%
  select(-has_cf, -COVIDseverity)

indx_hasCF <- sapply(has_CF, is.factor)
has_CF[indx_hasCF] <- lapply(has_CF[indx_hasCF], 
                           function(x) as.numeric(as.character(x)))

has_noCF <- morb_noCF %>%
  select(-has_cf, -COVIDseverity)

indx_hasNoCF <- sapply(has_noCF, is.factor)
has_noCF[indx_hasNoCF] <- lapply(has_noCF[indx_hasNoCF], 
                           function(x) as.numeric(as.character(x)))

cyst_fibrosis_patients <- colSums(has_CF)
noncyst_fibrosis_patients <- colSums(has_noCF)

cf_lvls <- rbind(cyst_fibrosis_patients, noncyst_fibrosis_patients)
cf_lvls[1,] <- prop1(cf_lvls[1,], 10316)
cf_lvls[2,] <- prop1(cf_lvls[2,], 350994)

melted_cf_lvls <- melt(cf_lvls)
colnames(melted_cf_lvls) <- c('has_CF', 'morbidity','proportion')
```

```{r visuals cf lvls}
ggplot(melted_cf_lvls, aes(x=morbidity, y = proportion, fill = proportion)) +
  geom_bar(stat = 'identity') +
  coord_flip()+
  labs( x = 'Morbidities', y = 'Proportion of Conditions') +
  ggtitle('Dominant Conditions in CF and non-CF patients with Covid 19') +
  theme(plot.title = element_text(hjust = 0.5)) +
  facet_wrap(~has_CF) + 
  theme(axis.text.x = element_text(angle=45))
```


```{r # of morbidities in patients}
#number of mordidities in each patient
num_morb_perCF <- table(rowSums(has_CF))
num_morb_perNonCF <- table(rowSums(has_noCF))

#Assign proportions for the number of comorbidities per patient
num_morb_perCF <- prop1(num_morb_perCF, 9337)
num_morb_perNonCF <- prop1(num_morb_perNonCF, 916615)
```


## Part 2

## Part 3

## Part 4

```{r}
#contingency table, compares non-cf covid severity with race
non_cf %>% 
  group_by(COVIDseverity, encountertype) %>% 
  summarize(N = n()) %>% 
  mutate(Ratio = round(N / sum(N), 3)) %>% 
  knitr::kable()
```

```{r}
#contingency table, compares cf covid severity with encountertype
cf %>% 
  group_by(COVIDseverity, encountertype) %>% 
  summarize(N = n()) %>% 
  mutate(Ratio = round(N / sum(N), 3)) %>% 
  knitr::kable()
```

```{r}
#contingency table, compares cf covid severity with encountertype
non_cf %>% 
  group_by(COVIDseverity, encountertype) %>% 
  summarize(N = n()) %>% 
  mutate(Ratio = round(N / sum(N), 3)) %>% 
  knitr::kable()
```

```{r}
#contingency table, compares covid severity between cf and non-cf
con_tab %>% 
  group_by(has_cf, COVIDseverity) %>% 
  summarize(N = n()) %>% 
  mutate(Ratio = round((N / sum(N)), 3)) %>% 
  knitr::kable()
```

```{r}
#contingency table, compares covid severity between cf and non-cf
ratetable <- con_tab %>% 
  group_by(has_cf, COVIDseverity) %>% 
  summarize(N = n()) %>% 
  mutate(Ratio = round(100*(N / sum(N)), 1), "%") %>% 
  knitr::kable()
```
```{r}
ratetable <- con_tab %>% 
  group_by(has_cf, COVIDseverity) %>% 
  summarize(N = n()) %>% 
  mutate(Ratio = round((N / sum(N)), 3))
```


```{r}
#bar plot, covid severity for cf patients
ggplot(ratetable, aes(x = has_cf,
                      y = Ratio,
                      fill = COVIDseverity), position = "dodge") +
    labs(x = "Patients Without CF", 
       y = "Rate", 
       title = "COVID Severity Among Children With/Without Cystic Fibrosis") +
  geom_bar(stat = "identity")
```

```{r}
library(ggplot2)
theme_set(theme_classic())

ratetable <-
```


```{r}
#bar plot, covid severity for non-cf patients
ggplot(non_cf) +
  geom_bar(mapping = aes(x=has_cf, fill = COVIDseverity), 
           position = 'dodge') +
  scale_y_continuous(labels = comma) +
  labs(x = "Patients Without CF", 
       y = "Count", 
       title = "COVID Severity Among Children Without Cystic Fibrosis")
```

```{r}
ggplot(con_tab) +
  geom_bar(mapping = aes(x=has_cf, fill = COVIDseverity), 
           position = 'dodge') +
  coord_cartesian(ylim = c(0, 60000)) +
  scale_y_continuous(labels = comma)
```


## Part 5
```{r}
non_cf <- d %>%
  filter(has_cf == 0)
```

```{r}
non_cf %>% 
  ggplot(aes(x=COVIDseverity)) +
  geom_bar(fill = "magenta")
```
```{r}
  d %>% 
  select(has_cf, COVIDseverity) %>% 
  table()
```
```{r}
non_cf %>% 
  select(age_at_encounter, ethnicity) %>% 
  table()
```
```{r}
non_cf %>%
 group_by(COVIDseverity) %>%
 count()
```
```{r}
non_cf %>% 
  select(COVIDseverity, ethnicity) %>% 
  table()
```
```{r}
non_cf %>% 
  select(COVIDseverity, zip_code) %>% 
  table()
```
```{r}
non_cf %>% 
  select(COVIDseverity, race) %>% 
  table()
```
```{r}
non_cf %>% 
  select(COVIDseverity, encountertype) %>% 
  table()
```
```{r}
non_cf %>% 
  ggplot(aes(x=COVIDseverity,
             y=age_at_encounter, fill = COVIDseverity)) +
  geom_boxplot() +
  labs(x = "COVID Severity", 
       y = "Age at Encounter", 
       title = "COVID Severity among children without Cystic Fibrosis") +
  scale_fill_manual(values =c("#E69F00","#009E73","#56B4E9"))
```
```{r}
non_cf %>% 
  ggplot(aes(x=COVIDseverity, fill = race)) +
  geom_bar()
```
```{r}
d %>% 
  ggplot(aes(x=COVIDseverity,
             y=age_at_encounter, 
             fill = has_cf)) +
  geom_boxplot() +
  labs(x = "COVID Severity", y = "Age at Encounter") +
  ggtitle("COVID Severity Among Children based on Age") +
  theme(plot.title = element_text(hjust = 0.5)) +
  scale_fill_manual(values =c("#E69F00","#009E73"), 
                    labels = c("Non CF","CF"), 
                    name = "Cystic Fibrosis Diagnosis") 
```
```{r}
non_cf %>% 
  ggplot(aes(x=race, fill = COVIDseverity)) +
  geom_bar(position = "dodge") + 
  coord_flip() +
  labs(x = "Race", y = "Count") +
  ggtitle("COVID Severity Among Children based on Race") +
  theme(plot.title = element_text(hjust = 0.5)) +
  scale_fill_manual(values =c("#E69F00","#009E73","#56B4E9"), 
                    labels = c("Asymptomatic","Moderate","Severe"),
                    name = "COVID Severity") +
  scale_y_continuous(labels = comma)
```
```{r}
non_cf %>% 
  ggplot(aes(x=ethnicity, fill = COVIDseverity)) +
  geom_bar(position = "dodge") +
  labs(x = "Ethnicity", y = "Count") +
  ggtitle("COVID Severity Among Children based on Ethnicity") +
  theme(plot.title = element_text(hjust = 0.5)) +
  scale_fill_manual(values =c("#E69F00","#009E73","#56B4E9"), 
                    labels = c("Asymptomatic","Moderate","Severe"),
                    name = "COVID Severity") +
  scale_y_continuous(labels = comma)
```
```{r}
d %>% 
  ggplot(aes(x=encountertype, 
             fill = has_cf)) +
  geom_bar(position = "dodge") +
  labs(x = "Type of Encounter", y = "Count") +
  ggtitle("COVID Severity Among Children based on Type of Encounter") +
  theme(plot.title = element_text(hjust = 0.5)) +
  scale_fill_manual(values =c("#E69F00","#009E73"), 
                    labels = c("Non CF","CF"), 
                    name = "Cystic Fibrosis Diagnosis") +
  coord_flip() +
  scale_y_continuous(labels = comma)
```
```{r}
table(d$ethnicity,d$has_cf)
```
```{r}
table(d$race,d$COVIDseverity)
```

X AXIS 3 CATEGORIES Y AXIS 2 CATEGORIES
```{r}
table(d$ethnicity,d$encountertype)
```








